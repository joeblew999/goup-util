# https://taskfile.dev
# Development tasks for goup-util
#
# Namespaced as 'dev:' in main Taskfile
#
version: '3'

# Vars inherited from main Taskfile.yml: GOUP, HYBRID_EXAMPLE, HYBRID_SCHEMES

tasks:
  # ===========================================================================
  # BUILD & TEST
  # ===========================================================================

  build:
    desc: Build goup-util binary for development
    cmds:
      - mkdir -p .bin
      - go build -o .bin/goup-util .

  test:
    desc: Run tests
    cmds:
      - task: ci:test

  config:
    desc: Show goup-util configuration
    cmds:
      - "{{.GOUP}} config"

  doctor:
    desc: Check Gio version compatibility
    cmds:
      - echo "Checking .src dependencies..."
      - task src:status || echo ".src not configured"
      - echo ""
      - echo "Checking example replace directives..."
      - grep "replace gioui.org" {{.HYBRID_EXAMPLE}}/go.mod || echo "WARN - No replace directive"

  # ===========================================================================
  # SETUP
  # ===========================================================================

  setup:
    desc: Initial setup for development
    cmds:
      - echo "Setting up goup-util development environment..."
      - task: workspace:init
      - echo "Installing Android NDK..."
      - task: sdk:ndk
      - echo "Setup complete!"

  # ===========================================================================
  # WORKSPACE
  # ===========================================================================

  workspace:init:
    desc: Initialize Go workspace
    cmds:
      - go work init
      - go work use .
      - go work use examples/gio-basic
      - go work use examples/gio-plugin-webviewer
      - go work use examples/gio-plugin-hyperlink
      - go work use examples/hybrid-dashboard

  workspace:list:
    desc: List workspace modules
    cmds:
      - "{{.GOUP}} workspace list"

  # ===========================================================================
  # SDK
  # ===========================================================================

  sdk:ndk:
    desc: Install Android NDK
    cmds:
      - "{{.GOUP}} install ndk-bundle"

  sdk:android:
    desc: Install Android SDK
    cmds:
      - "{{.GOUP}} install android-sdk"

  sdk:list:
    desc: List available SDKs
    cmds:
      - "{{.GOUP}} list"

  # ===========================================================================
  # SELF BUILD
  # ===========================================================================

  self:build:
    desc: Build goup-util for all platforms
    cmds:
      - task: ci:self:build

  self:test:
    desc: Test self build locally
    cmds:
      - task: ci:self:test

  # ===========================================================================
  # CLEANUP
  # ===========================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - "{{.GOUP}} build clean || true"
      - rm -rf .bin/goup-util
      - rm -f goup-util goup-util-*

  clean:all:
    desc: Clean everything including SDKs
    cmds:
      - task: clean
      - "{{.GOUP}} cleanup"

  # ===========================================================================
  # DEMO (quick start)
  # ===========================================================================

  demo:
    desc: Quick demo - build and run hybrid-dashboard
    cmds:
      - "{{.GOUP}} run macos {{.HYBRID_EXAMPLE}}"

  demo:deeplink:
    desc: Demo with deep linking
    cmds:
      - "{{.GOUP}} run --schemes '{{.HYBRID_SCHEMES}}' macos {{.HYBRID_EXAMPLE}}"
      - sleep 2
      - 'open "hybrid://dashboard/stats"'

  # ===========================================================================
  # DOCUMENTATION
  # ===========================================================================

  docs:generate:
    desc: Generate CLI documentation from Cobra commands
    cmds:
      - "{{.GOUP}} generate all"
      - echo "Documentation generated in docs/cli/"

  docs:readme:
    desc: Generate CLI reference summary for README
    cmds:
      - echo "Generating CLI reference for README..."
      - |
        cat > docs/CLI-REFERENCE.md << 'EOF'
        # CLI Reference

        This is an auto-generated summary of goup-util commands.
        For detailed documentation, see [docs/cli/](cli/).

        ## Commands

        | Command | Description |
        |---------|-------------|
        EOF
      - |
        # Extract command descriptions from generated docs
        for f in docs/cli/goup-util_*.md; do
          name=$(basename "$f" .md | sed 's/goup-util_//' | sed 's/_/ /g')
          desc=$(grep -A1 "^## " "$f" | grep -v "^##" | head -1 | sed 's/^[[:space:]]*//')
          [ -n "$desc" ] && echo "| \`goup-util $name\` | $desc |" >> docs/CLI-REFERENCE.md
        done
      - echo "" >> docs/CLI-REFERENCE.md
      - echo "*Generated on $(date -u '+%Y-%m-%d')*" >> docs/CLI-REFERENCE.md
      - echo "CLI reference generated at docs/CLI-REFERENCE.md"

  # ===========================================================================
  # ANDROID DEVICE MANAGEMENT
  # ===========================================================================

  android:devices:
    desc: List connected Android devices
    cmds:
      - "{{.GOUP}} android devices"

  android:logs:
    desc: "Stream Android logs for Gio apps (Ctrl+C to stop)"
    cmds:
      - "{{.GOUP}} android logs"

  android:logs:all:
    desc: "Stream all Android device logs (Ctrl+C to stop)"
    cmds:
      - "{{.GOUP}} android logs --all"

  android:emulator:list:
    desc: List available Android emulators
    cmds:
      - "{{.GOUP}} android emulator list"

  android:emulator:start:
    desc: "Start Android emulator (usage: task dev:android:emulator:start AVD=Pixel_7_API_35)"
    requires:
      vars: [AVD]
    cmds:
      - "{{.GOUP}} android emulator start {{.AVD}}"

  android:screenshot:
    desc: Take screenshot from connected Android device
    vars:
      OUTPUT: '{{.OUTPUT | default "android-screenshot.png"}}'
    cmds:
      - "{{.GOUP}} android screenshot {{.OUTPUT}}"

  android:webview:
    desc: Check WebView version on connected Android device
    cmds:
      - "{{.GOUP}} android webview"

  android:uninstall:
    desc: "Uninstall app from device (usage: task dev:android:uninstall PKG=localhost.main)"
    requires:
      vars: [PKG]
    cmds:
      - "{{.GOUP}} android uninstall {{.PKG}}"

  # ===========================================================================
  # iOS SIMULATOR MANAGEMENT
  # ===========================================================================

  ios:devices:
    desc: List available iOS simulators
    cmds:
      - "{{.GOUP}} ios devices"

  ios:runtimes:
    desc: List available iOS runtimes
    cmds:
      - "{{.GOUP}} ios runtimes"

  ios:boot:
    desc: "Boot an iOS simulator (usage: task dev:ios:boot DEVICE='iPhone 15')"
    requires:
      vars: [DEVICE]
    cmds:
      - "{{.GOUP}} ios boot '{{.DEVICE}}'"

  ios:shutdown:
    desc: "Shutdown an iOS simulator (usage: task dev:ios:shutdown DEVICE='iPhone 15')"
    requires:
      vars: [DEVICE]
    cmds:
      - "{{.GOUP}} ios shutdown '{{.DEVICE}}'"

  ios:screenshot:
    desc: Take screenshot from booted iOS simulator
    vars:
      OUTPUT: '{{.OUTPUT | default "ios-screenshot.png"}}'
    cmds:
      - "{{.GOUP}} ios screenshot {{.OUTPUT}}"

  ios:screenshot:clean:
    desc: Take screenshot with clean status bar (9:41, full battery)
    vars:
      OUTPUT: '{{.OUTPUT | default "ios-screenshot.png"}}'
    cmds:
      - "{{.GOUP}} ios screenshot --clean-status {{.OUTPUT}}"

  ios:logs:
    desc: "Stream iOS simulator logs for Gio apps (Ctrl+C to stop)"
    cmds:
      - "{{.GOUP}} ios logs"

  ios:logs:all:
    desc: "Stream all iOS simulator logs (Ctrl+C to stop)"
    cmds:
      - "{{.GOUP}} ios logs --all"

  ios:install:
    desc: "Install app on booted simulator (usage: task dev:ios:install APP=path/to/app.app)"
    requires:
      vars: [APP]
    cmds:
      - "{{.GOUP}} ios install {{.APP}}"

  ios:uninstall:
    desc: "Uninstall app from simulator (usage: task dev:ios:uninstall BUNDLE=localhost.main)"
    requires:
      vars: [BUNDLE]
    cmds:
      - "{{.GOUP}} ios uninstall {{.BUNDLE}}"

  # ===========================================================================
  # UTM / WINDOWS TESTING
  # ===========================================================================

  utm:doctor:
    desc: Check UTM installation status
    cmds:
      - "{{.GOUP}} utm doctor"

  utm:list:
    desc: List available UTM VMs
    cmds:
      - "{{.GOUP}} utm list"

  utm:gallery:
    desc: Show available VM templates
    cmds:
      - "{{.GOUP}} utm gallery"

  utm:windows:create:
    desc: Create Windows 11 ARM VM from template
    cmds:
      - "{{.GOUP}} utm create windows-11-arm"

  utm:windows:start:
    desc: Start Windows 11 VM
    cmds:
      - "{{.GOUP}} utm start 'Windows 11'"

  utm:windows:stop:
    desc: Stop Windows 11 VM
    cmds:
      - "{{.GOUP}} utm stop 'Windows 11'"

  utm:windows:status:
    desc: Check Windows 11 VM status
    cmds:
      - "{{.GOUP}} utm status 'Windows 11'"

  utm:windows:setup:
    desc: Install toolchain in Windows VM (git, go, task via winget)
    cmds:
      - echo "Installing toolchain in Windows VM..."
      - "{{.GOUP}} utm exec 'Windows 11' -- self setup"
      - echo "Toolchain installed!"

  utm:windows:push:
    desc: Push goup-util binary to Windows VM
    vars:
      BINARY: goup-util-windows-arm64.exe
    cmds:
      - echo "Building Windows ARM64 binary..."
      - GOOS=windows GOARCH=arm64 go build -o {{.BINARY}} .
      - echo "Pushing to Windows VM..."
      - "{{.GOUP}} utm push 'Windows 11' ./{{.BINARY}} 'C:/Users/User/goup-util.exe'"
      - rm {{.BINARY}}
      - echo "Binary pushed to C:/Users/User/goup-util.exe"

  utm:windows:screenshot:info:
    desc: Test screenshot info in Windows VM
    cmds:
      - "{{.GOUP}} utm exec 'Windows 11' -- screenshot --info"

  utm:windows:screenshot:
    desc: Capture screenshot from Windows VM
    vars:
      OUTPUT: '{{.OUTPUT | default "windows-screenshot.png"}}'
    cmds:
      - "{{.GOUP}} utm screenshot 'Windows 11' {{.OUTPUT}}"

  utm:windows:screenshot:test:
    desc: Full screenshot test in Windows VM
    cmds:
      - echo "Testing screenshot capture in Windows VM..."
      - "{{.GOUP}} utm screenshot 'Windows 11' docs/screenshots/test-windows.png"
      - echo "Screenshot saved to docs/screenshots/test-windows.png"

  utm:windows:run:hybrid:
    desc: Build and run hybrid-dashboard in Windows VM
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.HYBRID_EXAMPLE}}"

  utm:windows:run:webviewer:
    desc: Build and run webviewer in Windows VM
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.WEBVIEWER_EXAMPLE}}"

  utm:windows:build:hybrid:
    desc: Build hybrid-dashboard natively in Windows VM
    cmds:
      - "{{.GOUP}} utm build 'Windows 11' windows {{.HYBRID_EXAMPLE}}"

  utm:windows:build:webviewer:
    desc: Build webviewer natively in Windows VM
    cmds:
      - "{{.GOUP}} utm build 'Windows 11' windows {{.WEBVIEWER_EXAMPLE}}"

  utm:windows:build:hybrid:pull:
    desc: Build hybrid-dashboard in VM and pull binary back to host
    cmds:
      - "{{.GOUP}} utm build --pull 'Windows 11' windows {{.HYBRID_EXAMPLE}}"

  utm:windows:test:all:
    desc: Full Windows test suite via UTM
    cmds:
      - echo "=== Full Windows Test Suite ==="
      - echo ""
      - echo "1. Checking VM status..."
      - task: utm:windows:status
      - echo ""
      - echo "2. Testing screenshot info..."
      - task: utm:windows:screenshot:info
      - echo ""
      - echo "3. Building and running hybrid-dashboard..."
      - task: utm:windows:run:hybrid
      - echo ""
      - echo "4. Taking screenshot..."
      - task: utm:windows:screenshot:test
      - echo ""
      - echo "=== Windows tests complete! ==="
