# https://taskfile.dev
# Screenshot tasks for all platforms
#
# Namespaced as 'screenshot:' in main Taskfile
# Usage: task screenshot:capture, task screenshot:android, task screenshot:ios, etc.
#
# Desktop screenshots require CGO (robotgo).
# Android/iOS screenshots use device-native tools (no CGO needed).
#
# Requires Screen Recording permission on macOS 10.15+
#
version: '3'

# Vars BASIC_EXAMPLE, WEBVIEWER_EXAMPLE, etc. inherited from main Taskfile.yml

vars:
  SRC_DIR: .src
  SCREENSHOT_DIR: docs/screenshots
  APPSTORE_DIR: docs/screenshots/appstore

tasks:
  # ===========================================================================
  # BUILD
  # ===========================================================================

  build:
    desc: Build goup-util with robotgo screenshot support (requires CGO)
    cmds:
      - echo "Building with robotgo support..."
      - mkdir -p .bin
      - CGO_ENABLED=1 go build -tags screenshot -o .bin/goup-util .

  # ===========================================================================
  # DESKTOP SCREENSHOTS (robotgo, requires CGO)
  # ===========================================================================

  capture:
    desc: Take a full screen screenshot (desktop)
    cmds:
      - CGO_ENABLED=1 go run -tags screenshot . screenshot screenshot.png

  info:
    desc: Show display information
    cmds:
      - CGO_ENABLED=1 go run -tags screenshot . screenshot --info

  region:
    desc: Capture a screen region (100,100 800x600)
    cmds:
      - CGO_ENABLED=1 go run -tags screenshot . screenshot --x 100 --y 100 -w 800 -H 600 screenshot-region.png

  delay:
    desc: Take screenshot with 3 second delay
    cmds:
      - CGO_ENABLED=1 go run -tags screenshot . screenshot --delay 3000 screenshot-delayed.png

  test:
    desc: Test screenshot functionality (all platforms)
    cmds:
      - echo "=== Desktop Screenshot Test ==="
      - CGO_ENABLED=1 go run -tags screenshot . screenshot --info
      - echo "Taking test screenshot..."
      - CGO_ENABLED=1 go run -tags screenshot . screenshot --force test-screenshot.png
      - ls -lh test-screenshot.png
      - rm -f test-screenshot.png
      - echo ""
      - echo "=== Android Screenshot Test ==="
      - "{{.GOUP}} android screenshot test-android.png || echo 'No Android device (skipped)'"
      - rm -f test-android.png
      - echo ""
      - echo "=== iOS Screenshot Test ==="
      - "{{.GOUP}} ios screenshot test-ios.png || echo 'No iOS simulator booted (skipped)'"
      - rm -f test-ios.png
      - echo ""
      - echo "Screenshot test complete"

  # ===========================================================================
  # ANDROID SCREENSHOTS (via adb screencap, no CGO needed)
  # ===========================================================================

  android:
    desc: Capture Android emulator/device screenshot
    vars:
      OUTPUT: '{{.OUTPUT | default "android-screenshot.png"}}'
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - "{{.GOUP}} android screenshot {{.SCREENSHOT_DIR}}/{{.OUTPUT}}"

  android:hybrid:
    desc: Build hybrid-dashboard for Android, deploy, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building hybrid-dashboard for Android..."
      - "{{.GOUP}} build android {{.HYBRID_EXAMPLE}}"
      - echo "Installing on device..."
      - "{{.GOUP}} android install {{.HYBRID_EXAMPLE}}/.bin/android/gio-plugin-webviewer.apk"
      - echo "Launching..."
      - "{{.GOUP}} android launch localhost.main"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} android screenshot {{.SCREENSHOT_DIR}}/android-hybrid-dashboard.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/android-hybrid-dashboard.png"

  android:webviewer:
    desc: Build webviewer for Android, deploy, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building webviewer for Android..."
      - "{{.GOUP}} build android {{.WEBVIEWER_EXAMPLE}}"
      - echo "Installing on device..."
      - "{{.GOUP}} android install {{.WEBVIEWER_EXAMPLE}}/.bin/android/gio-plugin-webviewer.apk"
      - echo "Launching..."
      - "{{.GOUP}} android launch localhost.main"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} android screenshot {{.SCREENSHOT_DIR}}/android-webviewer.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/android-webviewer.png"

  android:all:
    desc: Capture Android screenshots of all examples
    cmds:
      - echo "Capturing Android screenshots..."
      - task: android:webviewer
      - task: android:hybrid
      - echo ""
      - echo "Android screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/android-*

  # ===========================================================================
  # iOS SIMULATOR SCREENSHOTS (via simctl, no CGO needed)
  # ===========================================================================

  ios:
    desc: Capture iOS simulator screenshot
    vars:
      OUTPUT: '{{.OUTPUT | default "ios-screenshot.png"}}'
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - "{{.GOUP}} ios screenshot --clean-status {{.SCREENSHOT_DIR}}/{{.OUTPUT}}"

  ios:hybrid:
    desc: Build hybrid-dashboard for iOS simulator, deploy, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building hybrid-dashboard for iOS simulator..."
      - "{{.GOUP}} build ios-simulator {{.HYBRID_EXAMPLE}}"
      - echo "Installing on simulator..."
      - "{{.GOUP}} ios install {{.HYBRID_EXAMPLE}}/.bin/ios-simulator/gio-plugin-webviewer.app"
      - echo "Launching..."
      - "{{.GOUP}} ios launch localhost.main"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} ios screenshot --clean-status {{.SCREENSHOT_DIR}}/ios-hybrid-dashboard.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/ios-hybrid-dashboard.png"

  ios:webviewer:
    desc: Build webviewer for iOS simulator, deploy, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building webviewer for iOS simulator..."
      - "{{.GOUP}} build ios-simulator {{.WEBVIEWER_EXAMPLE}}"
      - echo "Installing on simulator..."
      - "{{.GOUP}} ios install {{.WEBVIEWER_EXAMPLE}}/.bin/ios-simulator/gio-plugin-webviewer.app"
      - echo "Launching..."
      - "{{.GOUP}} ios launch localhost.main"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} ios screenshot --clean-status {{.SCREENSHOT_DIR}}/ios-webviewer.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/ios-webviewer.png"

  ios:all:
    desc: Capture iOS simulator screenshots of all examples
    cmds:
      - echo "Capturing iOS simulator screenshots..."
      - task: ios:webviewer
      - task: ios:hybrid
      - echo ""
      - echo "iOS screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/ios-*

  # ===========================================================================
  # EXAMPLE APP SCREENSHOTS (desktop via robotgo)
  # ===========================================================================

  example:hybrid:
    desc: Capture hybrid-dashboard screenshot (desktop)
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.HYBRID_EXAMPLE}} {{.SCREENSHOT_DIR}}/hybrid-dashboard.png

  example:webviewer:
    desc: Capture webviewer example screenshot (desktop)
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.WEBVIEWER_EXAMPLE}} {{.SCREENSHOT_DIR}}/webviewer.png

  example:hyperlink:
    desc: Capture hyperlink example screenshot (desktop)
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.HYPERLINK_EXAMPLE}} {{.SCREENSHOT_DIR}}/hyperlink.png

  example:basic:
    desc: Capture basic example screenshot (desktop)
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.BASIC_EXAMPLE}} {{.SCREENSHOT_DIR}}/basic.png

  example:all:
    desc: Capture screenshots of all examples (desktop)
    cmds:
      - echo "Capturing all desktop example screenshots..."
      - mkdir -p {{.SCREENSHOT_DIR}}
      - task: example:hybrid
      - task: example:webviewer
      - task: example:basic
      - echo ""
      - echo "Screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/

  # ===========================================================================
  # ALL PLATFORMS (unified)
  # ===========================================================================

  all:
    desc: Capture screenshots on all available platforms (desktop + Android + iOS + Windows)
    cmds:
      - echo "=== macOS Desktop Screenshots ==="
      - task: example:all
      - echo ""
      - echo "=== Android Screenshots ==="
      - task: android:all
      - echo ""
      - echo "=== iOS Simulator Screenshots ==="
      - task: ios:all
      - echo ""
      - echo "=== Windows VM Screenshots ==="
      - task: windows:all
        ignore_error: true
      - echo ""
      - echo "All platform screenshots saved to {{.SCREENSHOT_DIR}}/"

  # ===========================================================================
  # .SRC DEMO SCREENSHOTS
  # ===========================================================================

  src:webviewer:
    desc: Capture .src webviewer demo screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.SRC_DIR}}/gio-plugins/webviewer/demo {{.SCREENSHOT_DIR}}/src-webviewer-demo.png

  src:hyperlink:
    desc: Capture .src hyperlink demo screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture {{.SRC_DIR}}/gio-plugins/hyperlink/demo {{.SCREENSHOT_DIR}}/src-hyperlink-demo.png

  src:all:
    desc: Capture screenshots of all .src demos
    cmds:
      - echo "Capturing all .src demo screenshots..."
      - mkdir -p {{.SCREENSHOT_DIR}}
      - task: src:webviewer
      - task: src:hyperlink
      - echo ""
      - echo "Screenshots saved to {{.SCREENSHOT_DIR}}/"

  # ===========================================================================
  # WINDOWS SCREENSHOTS (via UTM VM, no CGO needed)
  # ===========================================================================

  windows:
    desc: Capture Windows VM screenshot
    vars:
      OUTPUT: '{{.OUTPUT | default "windows-screenshot.png"}}'
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - "{{.GOUP}} utm screenshot 'Windows 11' {{.SCREENSHOT_DIR}}/{{.OUTPUT}}"

  windows:hybrid:
    desc: Build hybrid-dashboard for Windows, deploy to VM, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building hybrid-dashboard for Windows..."
      - "{{.GOUP}} build windows {{.HYBRID_EXAMPLE}}"
      - echo "Pushing to Windows VM and running..."
      - "{{.GOUP}} utm run 'Windows 11' {{.HYBRID_EXAMPLE}}"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} utm screenshot 'Windows 11' {{.SCREENSHOT_DIR}}/windows-hybrid-dashboard.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/windows-hybrid-dashboard.png"

  windows:webviewer:
    desc: Build webviewer for Windows, deploy to VM, and screenshot
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "Building webviewer for Windows..."
      - "{{.GOUP}} build windows {{.WEBVIEWER_EXAMPLE}}"
      - echo "Pushing to Windows VM and running..."
      - "{{.GOUP}} utm run 'Windows 11' {{.WEBVIEWER_EXAMPLE}}"
      - echo "Waiting for app to render..."
      - sleep 5
      - echo "Capturing screenshot..."
      - "{{.GOUP}} utm screenshot 'Windows 11' {{.SCREENSHOT_DIR}}/windows-webviewer.png"
      - echo "Screenshot saved to {{.SCREENSHOT_DIR}}/windows-webviewer.png"

  windows:all:
    desc: Capture Windows VM screenshots of all examples
    cmds:
      - echo "Capturing Windows VM screenshots..."
      - task: windows:webviewer
      - task: windows:hybrid
      - echo ""
      - echo "Windows screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/windows-*

  # ===========================================================================
  # APP STORE SCREENSHOTS
  # ===========================================================================

  appstore:ios:
    desc: Generate iOS App Store screenshots from simulator (native resolution)
    cmds:
      - mkdir -p {{.APPSTORE_DIR}}/ios
      - echo "Capturing iOS App Store screenshots from simulator..."
      - "{{.GOUP}} ios screenshot --clean-status {{.APPSTORE_DIR}}/ios/simulator.png"
      - ls -lh {{.APPSTORE_DIR}}/ios/

  appstore:macos:
    desc: Generate macOS App Store screenshots (robotgo)
    cmds:
      - mkdir -p {{.APPSTORE_DIR}}/macos
      - echo "Capturing macOS App Store screenshots..."
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture --preset macos-retina {{.HYBRID_EXAMPLE}} {{.APPSTORE_DIR}}/macos/retina.png
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture --preset macos-retina-2k {{.HYBRID_EXAMPLE}} {{.APPSTORE_DIR}}/macos/retina-2k.png
      - CGO_ENABLED=1 go run -tags screenshot . run-and-capture --preset macos-standard {{.HYBRID_EXAMPLE}} {{.APPSTORE_DIR}}/macos/standard.png
      - ls -lh {{.APPSTORE_DIR}}/macos/

  appstore:android:
    desc: Generate Android Play Store screenshots from device/emulator
    cmds:
      - mkdir -p {{.APPSTORE_DIR}}/android
      - echo "Capturing Android Play Store screenshots from device..."
      - "{{.GOUP}} android screenshot {{.APPSTORE_DIR}}/android/device.png"
      - ls -lh {{.APPSTORE_DIR}}/android/

  appstore:windows:
    desc: Generate Windows Store screenshots from UTM VM
    cmds:
      - mkdir -p {{.APPSTORE_DIR}}/windows
      - echo "Capturing Windows Store screenshots from VM..."
      - "{{.GOUP}} utm screenshot 'Windows 11' {{.APPSTORE_DIR}}/windows/vm.png"
      - ls -lh {{.APPSTORE_DIR}}/windows/

  appstore:all:
    desc: Generate ALL App Store screenshots (iOS, macOS, Android, Windows)
    cmds:
      - echo "Generating App Store screenshots for all platforms..."
      - task: appstore:ios
      - task: appstore:macos
      - task: appstore:android
      - task: appstore:windows
      - echo ""
      - echo "All App Store screenshots generated"
      - echo "See {{.APPSTORE_DIR}}/"

  # ===========================================================================
  # DOCUMENTATION (one-command screenshot all examples)
  # ===========================================================================

  docs:
    desc: "Screenshot ALL examples for docs (desktop only, no CGO: use docs:all for all platforms)"
    cmds:
      - echo "Capturing documentation screenshots..."
      - task: example:all
      - echo ""
      - echo "Screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/

  docs:all:
    desc: "Screenshot ALL examples on ALL platforms into docs/screenshots/"
    cmds:
      - mkdir -p {{.SCREENSHOT_DIR}}
      - echo "=== 1/4 macOS Desktop Screenshots (robotgo) ==="
      - task: example:all
      - echo ""
      - echo "=== 2/4 Android Screenshots (adb) ==="
      - task: android:all
        ignore_error: true
      - echo ""
      - echo "=== 3/4 iOS Simulator Screenshots (simctl) ==="
      - task: ios:all
        ignore_error: true
      - echo ""
      - echo "=== 4/4 Windows VM Screenshots (UTM) ==="
      - task: windows:all
        ignore_error: true
      - echo ""
      - echo "All screenshots saved to {{.SCREENSHOT_DIR}}/"
      - ls -la {{.SCREENSHOT_DIR}}/
