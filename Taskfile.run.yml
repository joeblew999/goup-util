# https://taskfile.dev
# Direct run tasks (go run . - fastest iteration)
#
# Namespaced as 'run:' in main Taskfile
# Usage: task run:hybrid, task run:webviewer, etc.
#
version: '3'

# Vars inherited from main Taskfile.yml

tasks:
  # ===========================================================================
  # DIRECT RUN (go run . - fastest iteration)
  # ===========================================================================

  hybrid:
    desc: Run hybrid-dashboard directly (fastest)
    dir: "{{.HYBRID_EXAMPLE}}"
    cmds:
      - go run .

  webviewer:
    desc: Run webviewer example directly
    dir: "{{.WEBVIEWER_EXAMPLE}}"
    cmds:
      - go run .

  hyperlink:
    desc: Run hyperlink example directly
    dir: "{{.HYPERLINK_EXAMPLE}}"
    cmds:
      - go run .

  basic:
    desc: Run basic example directly
    dir: "{{.BASIC_EXAMPLE}}"
    cmds:
      - go run .

  # ===========================================================================
  # BUILD AND LAUNCH (via gogio - creates .app bundles)
  # ===========================================================================

  launch:hybrid:
    desc: Build and run hybrid-dashboard (macOS)
    cmds:
      - "{{.GOUP}} run macos {{.HYBRID_EXAMPLE}}"

  launch:hybrid:deeplink:
    desc: Build and run hybrid-dashboard with deep linking (macOS)
    cmds:
      - "{{.GOUP}} run --schemes '{{.HYBRID_SCHEMES}}' macos {{.HYBRID_EXAMPLE}}"
      - echo ""
      - 'echo "Test with: open hybrid://dashboard/stats"'

  launch:webviewer:
    desc: Build and run webviewer example (macOS)
    cmds:
      - "{{.GOUP}} run macos {{.WEBVIEWER_EXAMPLE}}"

  launch:basic:
    desc: Build and run basic example (macOS)
    cmds:
      - "{{.GOUP}} run macos {{.BASIC_EXAMPLE}}"

  # ===========================================================================
  # BUILD AND LAUNCH (iOS simulator - via gogio + simctl)
  # ===========================================================================

  launch:hybrid:ios:
    desc: Build and run hybrid-dashboard (iOS simulator)
    cmds:
      - "{{.GOUP}} run ios-simulator {{.HYBRID_EXAMPLE}}"

  launch:webviewer:ios:
    desc: Build and run webviewer example (iOS simulator)
    cmds:
      - "{{.GOUP}} run ios-simulator {{.WEBVIEWER_EXAMPLE}}"

  launch:basic:ios:
    desc: Build and run basic example (iOS simulator)
    cmds:
      - "{{.GOUP}} run ios-simulator {{.BASIC_EXAMPLE}}"

  # ===========================================================================
  # WEBVIEWER SHELL (zero-compile exercise)
  # ===========================================================================

  shell:
    desc: "Build webviewer shell, set config, and launch (usage: task run:shell URL=https://example.com)"
    vars:
      URL: '{{.URL | default "https://test-hono.gedw99.workers.dev/?local"}}'
      APP_NAME: '{{.APP_NAME | default "Gio WebViewer"}}'
      SHELL_DIR: "{{.WEBVIEWER_EXAMPLE}}/.bin/macos"
    cmds:
      - "{{.GOUP}} build macos {{.WEBVIEWER_EXAMPLE}}"
      - |
        cat > {{.SHELL_DIR}}/app.json << 'ENDJSON'
        {
            "url": "{{.URL}}",
            "name": "{{.APP_NAME}}",
            "width": 1200,
            "height": 800,
            "update": {
                "repo": "joeblew999/goup-util",
                "asset": "webviewer-shell"
            }
        }
        ENDJSON
      - echo "Launching shell with URL {{.URL}}"
      - open {{.SHELL_DIR}}/gio-plugin-webviewer.app

  shell:update:
    desc: Test webviewer shell self-update (checks GitHub releases)
    vars:
      SHELL_BIN: "{{.WEBVIEWER_EXAMPLE}}/.bin/macos/gio-plugin-webviewer.app/Contents/MacOS/gio-plugin-webviewer"
    cmds:
      - "{{.SHELL_BIN}} --update || echo 'Update check completed (no release asset published yet)'"

  # ===========================================================================
  # ANDROID (build + deploy to device via goup-util)
  # ===========================================================================

  webviewer:android:
    desc: Build, install, and launch webviewer on connected Android device
    cmds:
      - "{{.GOUP}} run android {{.WEBVIEWER_EXAMPLE}}"

  hybrid:android:
    desc: Build, install, and launch hybrid-dashboard on connected Android device
    cmds:
      - "{{.GOUP}} run android {{.HYBRID_EXAMPLE}}"

  basic:android:
    desc: Build, install, and launch basic example on connected Android device
    cmds:
      - "{{.GOUP}} run android {{.BASIC_EXAMPLE}}"

  hyperlink:android:
    desc: Build, install, and launch hyperlink example on connected Android device
    cmds:
      - "{{.GOUP}} run android {{.HYPERLINK_EXAMPLE}}"

  all:android:
    desc: Build and install all examples on connected Android device
    cmds:
      - task: webviewer:android
      - task: hybrid:android
      - task: basic:android
      - task: hyperlink:android

  # ===========================================================================
  # iOS SIMULATOR (build + deploy to simulator via goup-util)
  # ===========================================================================

  webviewer:ios:
    desc: Build, install, and launch webviewer on iOS simulator
    cmds:
      - "{{.GOUP}} run ios-simulator {{.WEBVIEWER_EXAMPLE}}"

  hybrid:ios:
    desc: Build, install, and launch hybrid-dashboard on iOS simulator
    cmds:
      - "{{.GOUP}} run ios-simulator {{.HYBRID_EXAMPLE}}"

  basic:ios:
    desc: Build, install, and launch basic example on iOS simulator
    cmds:
      - "{{.GOUP}} run ios-simulator {{.BASIC_EXAMPLE}}"

  hyperlink:ios:
    desc: Build, install, and launch hyperlink example on iOS simulator
    cmds:
      - "{{.GOUP}} run ios-simulator {{.HYPERLINK_EXAMPLE}}"

  all:ios:
    desc: Build and install all examples on iOS simulator
    cmds:
      - task: webviewer:ios
      - task: hybrid:ios
      - task: basic:ios
      - task: hyperlink:ios

  # ===========================================================================
  # WINDOWS (build + run in UTM VM via goup-util)
  # ===========================================================================

  webviewer:windows:
    desc: Build webviewer and run in Windows VM (via UTM)
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.WEBVIEWER_EXAMPLE}}"

  hybrid:windows:
    desc: Build hybrid-dashboard and run in Windows VM (via UTM)
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.HYBRID_EXAMPLE}}"

  basic:windows:
    desc: Build basic example and run in Windows VM (via UTM)
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.BASIC_EXAMPLE}}"

  hyperlink:windows:
    desc: Build hyperlink example and run in Windows VM (via UTM)
    cmds:
      - "{{.GOUP}} utm run 'Windows 11' {{.HYPERLINK_EXAMPLE}}"

  all:windows:
    desc: Build and run all examples in Windows VM (via UTM)
    cmds:
      - task: webviewer:windows
      - task: hybrid:windows
      - task: basic:windows
      - task: hyperlink:windows

  # ===========================================================================
  # DEEP LINKING TESTS
  # ===========================================================================

  test:deeplink:
    desc: Test deep linking with various URLs
    cmds:
      - echo "Testing deep link schemes..."
      - 'open "hybrid://dashboard/stats" || echo "App may need to be running"'
      - sleep 1
      - 'open "hybrid://dashboard/hello" || echo "App may need to be running"'
