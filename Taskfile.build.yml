# https://taskfile.dev
# Build tasks for example apps
#
# Namespaced as 'build:' in main Taskfile
# Usage: task build:hybrid:macos, task build:all, etc.
#
version: '3'

# Vars inherited from main Taskfile.yml

tasks:
  # ===========================================================================
  # BUILD HYBRID-DASHBOARD
  # ===========================================================================

  hybrid:macos:
    desc: Build hybrid-dashboard for macOS
    cmds:
      - "{{.GOUP}} build macos {{.HYBRID_EXAMPLE}}"

  hybrid:macos:force:
    desc: Force rebuild hybrid-dashboard for macOS
    cmds:
      - "{{.GOUP}} build --force macos {{.HYBRID_EXAMPLE}}"

  hybrid:macos:check:
    desc: Check if hybrid-dashboard needs rebuilding
    cmds:
      - "{{.GOUP}} build --check macos {{.HYBRID_EXAMPLE}}"

  hybrid:macos:deeplink:
    desc: Build hybrid-dashboard for macOS with deep linking
    cmds:
      - "{{.GOUP}} build --schemes '{{.HYBRID_SCHEMES}}' macos {{.HYBRID_EXAMPLE}}"

  hybrid:ios:
    desc: Build hybrid-dashboard for iOS
    cmds:
      - "{{.GOUP}} build ios {{.HYBRID_EXAMPLE}}"

  hybrid:ios:force:
    desc: Force rebuild hybrid-dashboard for iOS
    cmds:
      - "{{.GOUP}} build --force ios {{.HYBRID_EXAMPLE}}"

  hybrid:ios:deeplink:
    desc: Build hybrid-dashboard for iOS with deep linking
    cmds:
      - "{{.GOUP}} build --schemes '{{.HYBRID_SCHEMES}}' ios {{.HYBRID_EXAMPLE}}"

  hybrid:android:
    desc: Build hybrid-dashboard for Android
    cmds:
      - "{{.GOUP}} build android {{.HYBRID_EXAMPLE}}"

  hybrid:android:force:
    desc: Force rebuild hybrid-dashboard for Android
    cmds:
      - "{{.GOUP}} build --force android {{.HYBRID_EXAMPLE}}"

  hybrid:android:deeplink:
    desc: Build hybrid-dashboard for Android with deep linking
    cmds:
      - "{{.GOUP}} build --schemes '{{.HYBRID_SCHEMES}}' android {{.HYBRID_EXAMPLE}}"

  hybrid:windows:
    desc: Build hybrid-dashboard for Windows
    cmds:
      - "{{.GOUP}} build windows {{.HYBRID_EXAMPLE}}"

  hybrid:windows:deeplink:
    desc: Build hybrid-dashboard for Windows with deep linking
    cmds:
      - "{{.GOUP}} build --schemes '{{.HYBRID_SCHEMES}}' windows {{.HYBRID_EXAMPLE}}"

  # NOTE: WASM builds currently fail - see web: task comment above
  hybrid:web:
    desc: Build hybrid-dashboard for web (WASM - BROKEN until upstream fix)
    deps: [gogio]
    dir: "{{.HYBRID_EXAMPLE}}"
    cmds:
      - mkdir -p .bin/web
      - 'echo "WARNING: WASM builds currently broken due to os/user in go-text/typesetting/fontscan"'
      - '../../.src/gogio -target js -o .bin/web . || echo "WASM build failed"'

  hybrid:all:
    desc: Build hybrid-dashboard for all platforms
    cmds:
      - task: hybrid:macos
      - task: hybrid:ios
      - task: hybrid:android
      - task: hybrid:windows
      - task: hybrid:web

  hybrid:all:deeplink:
    desc: Build hybrid-dashboard for all platforms with deep linking
    cmds:
      - task: hybrid:macos:deeplink
      - task: hybrid:ios:deeplink
      - task: hybrid:android:deeplink
      - task: hybrid:windows:deeplink

  # ===========================================================================
  # BUILD BASIC EXAMPLE
  # ===========================================================================

  basic:macos:
    desc: Build gio-basic for macOS
    cmds:
      - "{{.GOUP}} build macos {{.BASIC_EXAMPLE}}"

  basic:linux:
    desc: Build gio-basic for Linux
    cmds:
      - "{{.GOUP}} build linux {{.BASIC_EXAMPLE}}"

  basic:windows:
    desc: Build gio-basic for Windows
    cmds:
      - "{{.GOUP}} build windows {{.BASIC_EXAMPLE}}"

  # ===========================================================================
  # BUILD ALL EXAMPLES
  # ===========================================================================

  macos:
    desc: Build all examples for macOS
    cmds:
      - "{{.GOUP}} build macos {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.HYBRID_EXAMPLE}}"

  ios:
    desc: Build all examples for iOS
    cmds:
      - "{{.GOUP}} build ios {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build ios {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build ios {{.HYBRID_EXAMPLE}}"

  android:
    desc: Build all examples for Android
    cmds:
      - "{{.GOUP}} build android {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build android {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build android {{.HYBRID_EXAMPLE}}"

  # Build gogio tool from .src (respects .src pattern)
  gogio:
    desc: Build gogio tool from .src/gio-cmd
    dir: .src/gio-cmd
    cmds:
      - go build -o ../gogio ./gogio
    status:
      - test -f .src/gogio
    sources:
      - .src/gio-cmd/gogio/**/*.go

  # NOTE: WASM builds currently fail due to upstream issue in go-text/typesetting:
  # The fontscan package imports os/user which is not supported in WASM.
  # Track: https://github.com/go-text/typesetting - needs WASM build tag support
  web:
    desc: Build basic example for web (WASM - BROKEN until upstream fix)
    deps: [gogio]
    dir: "{{.BASIC_EXAMPLE}}"
    cmds:
      - mkdir -p .bin/web
      - 'echo "WARNING: WASM builds currently broken due to os/user in go-text/typesetting/fontscan"'
      - '../../.src/gogio -target js -o .bin/web . || echo "WASM build failed"'

  all:
    desc: Build all examples for all platforms
    cmds:
      - task: macos
      - task: ios
      - task: android
      - task: web

  # ===========================================================================
  # BUNDLING & PACKAGING
  # ===========================================================================

  bundle:hybrid:macos:
    desc: Create signed macOS app bundle for hybrid-dashboard
    cmds:
      - "{{.GOUP}} bundle macos {{.HYBRID_EXAMPLE}}"

  # ===========================================================================
  # ICONS
  # ===========================================================================

  icons:hybrid:
    desc: Generate icons for hybrid-dashboard (all platforms)
    cmds:
      - "{{.GOUP}} icons macos {{.HYBRID_EXAMPLE}}"
      - "{{.GOUP}} icons android {{.HYBRID_EXAMPLE}}"
      - "{{.GOUP}} icons ios {{.HYBRID_EXAMPLE}}"

  # ===========================================================================
  # CLEANUP
  # ===========================================================================

  clean:
    desc: Clean build artifacts from all examples
    cmds:
      - rm -rf {{.BASIC_EXAMPLE}}/.bin
      - rm -rf {{.BASIC_EXAMPLE}}/.build
      - rm -rf {{.WEBVIEWER_EXAMPLE}}/.bin
      - rm -rf {{.WEBVIEWER_EXAMPLE}}/.build
      - rm -rf {{.HYPERLINK_EXAMPLE}}/.bin
      - rm -rf {{.HYPERLINK_EXAMPLE}}/.build
      - rm -rf {{.HYBRID_EXAMPLE}}/.bin
      - rm -rf {{.HYBRID_EXAMPLE}}/.build
