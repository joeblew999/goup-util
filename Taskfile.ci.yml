# https://taskfile.dev
# CI/CD and Release tasks
#
# Namespaced as 'ci:' in main Taskfile
# Usage: task ci:check, task ci:release:patch, etc.
#
version: '3'

# Vars inherited from main Taskfile.yml

tasks:
  # ===========================================================================
  # CI BUILD TASKS
  # ===========================================================================

  check:
    desc: Check if any examples need rebuilding (for CI)
    cmds:
      - echo "Checking build status for all examples..."
      - "{{.GOUP}} build --check macos {{.HYBRID_EXAMPLE}} && echo 'hybrid: up-to-date' || echo 'hybrid: needs rebuild'"
      - "{{.GOUP}} build --check macos {{.WEBVIEWER_EXAMPLE}} && echo 'webviewer: up-to-date' || echo 'webviewer: needs rebuild'"
      - "{{.GOUP}} build --check macos {{.BASIC_EXAMPLE}} && echo 'basic: up-to-date' || echo 'basic: needs rebuild'"

  build:
    desc: Build all examples (only if needed - idempotent)
    cmds:
      - echo "Building all examples (skipping if up-to-date)..."
      - "{{.GOUP}} build macos {{.HYBRID_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.BASIC_EXAMPLE}}"
      - echo "Build complete (used cache where possible)"

  build:force:
    desc: Force rebuild all examples (ignores cache)
    cmds:
      - echo "Force rebuilding all examples..."
      - "{{.GOUP}} build --force macos {{.HYBRID_EXAMPLE}}"
      - "{{.GOUP}} build --force macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build --force macos {{.BASIC_EXAMPLE}}"
      - echo "All examples rebuilt from scratch"

  test:
    desc: Run all tests
    cmds:
      - go test ./...

  test:all:
    desc: Build and test all examples on all platforms
    cmds:
      - echo "Building for macOS..."
      - "{{.GOUP}} build macos {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.HYBRID_EXAMPLE}}"
      - echo "Building for iOS..."
      - "{{.GOUP}} build ios {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build ios {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build ios {{.HYBRID_EXAMPLE}}"
      - echo "Building for Android..."
      - "{{.GOUP}} build android {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build android {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build android {{.HYBRID_EXAMPLE}}"
      - echo "All examples built successfully!"

  # ===========================================================================
  # RELEASE WORKFLOW
  # ===========================================================================

  release:prepare:
    desc: Prepare for release (check status, run tests)
    cmds:
      - echo "Checking git status..."
      - git status --short
      - echo ""
      - go test ./...
      - echo ""
      - echo "Ready to release!"

  release:tag:
    desc: Create and push a new release tag
    cmds:
      - echo "Current tags:"
      - git tag -l | tail -5
      - echo ""
      - 'echo "Enter new version (e.g., v0.1.0):"'
      - 'read -p "Version: " VERSION && git tag -a "$VERSION" -m "Release $VERSION" && git push origin main && git push origin "$VERSION"'
      - echo ""
      - echo "Tag pushed! GitHub Actions will build binaries."

  release:full:
    desc: Full release workflow (test, tag, push)
    cmds:
      - task: release:prepare
      - task: release:tag

  # ===========================================================================
  # BOOTSTRAP TESTING
  # ===========================================================================

  bootstrap:test:macos:
    desc: Test macOS bootstrap script (downloads latest release)
    cmds:
      - echo "Testing macOS bootstrap script..."
      - echo "This will install goup-util to /usr/local/bin/goup-util"
      - bash scripts/macos-bootstrap.sh

  bootstrap:test:macos:local:
    desc: Test macOS bootstrap script locally (debug mode)
    cmds:
      - bash -x scripts/macos-bootstrap.sh

  bootstrap:info:
    desc: Show bootstrap script URLs and installation locations
    cmds:
      - |
        echo "Bootstrap Script URLs:"
        echo ""
        echo "macOS:"
        echo "  curl -fsSL https://raw.githubusercontent.com/joeblew999/goup-util/main/scripts/macos-bootstrap.sh | bash"
        echo ""
        echo "Windows:"
        echo "  iwr https://raw.githubusercontent.com/joeblew999/goup-util/main/scripts/windows-bootstrap.ps1 -UseBasicParsing | iex"
        echo ""
        echo "Installation Locations:"
        echo "  macOS - /usr/local/bin/goup-util"
        echo "  Windows - %USERPROFILE%\\goup-util.exe"

  # ===========================================================================
  # SELF BUILD
  # ===========================================================================

  self:build:
    desc: Build goup-util binaries for all platforms
    cmds:
      - "{{.GOUP}} self build"

  self:test:
    desc: Test self build locally
    cmds:
      - "{{.GOUP}} self test"
