# https://taskfile.dev
# CI/CD and Release tasks
#
# Namespaced as 'ci:' in main Taskfile
# Usage: task ci:check, task ci:release:patch, etc.
#
version: '3'

# Vars inherited from main Taskfile.yml

tasks:
  # ===========================================================================
  # CI BUILD TASKS
  # ===========================================================================

  check:
    desc: Check if any examples need rebuilding (for CI)
    cmds:
      - echo "Checking build status for all examples..."
      - "{{.GOUP}} build --check macos {{.BASIC_EXAMPLE}} && echo 'basic: up-to-date' || echo 'basic: needs rebuild'"
      - "{{.GOUP}} build --check macos {{.HYPERLINK_EXAMPLE}} && echo 'hyperlink: up-to-date' || echo 'hyperlink: needs rebuild'"
      - "{{.GOUP}} build --check macos {{.WEBVIEWER_EXAMPLE}} && echo 'webviewer: up-to-date' || echo 'webviewer: needs rebuild'"
      - "{{.GOUP}} build --check macos {{.HYBRID_EXAMPLE}} && echo 'hybrid: up-to-date' || echo 'hybrid: needs rebuild'"

  build:
    desc: Build all examples (only if needed - idempotent)
    cmds:
      - echo "Building all examples (skipping if up-to-date)..."
      - "{{.GOUP}} build macos {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.HYPERLINK_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build macos {{.HYBRID_EXAMPLE}}"
      - echo "Build complete (used cache where possible)"

  build:force:
    desc: Force rebuild all examples (ignores cache)
    cmds:
      - echo "Force rebuilding all examples..."
      - "{{.GOUP}} build --force macos {{.BASIC_EXAMPLE}}"
      - "{{.GOUP}} build --force macos {{.HYPERLINK_EXAMPLE}}"
      - "{{.GOUP}} build --force macos {{.WEBVIEWER_EXAMPLE}}"
      - "{{.GOUP}} build --force macos {{.HYBRID_EXAMPLE}}"
      - echo "All examples rebuilt from scratch"

  test:
    desc: Run all tests
    cmds:
      - go test ./...

  test:all:
    desc: Build and test all examples on all platforms
    cmds:
      - echo "Building for macOS..."
      - task: build:macos
      - echo "Building for iOS..."
      - task: build:ios
      - echo "Building for Android..."
      - task: build:android
      - echo "All examples built successfully!"

  # ===========================================================================
  # RELEASE WORKFLOW
  # ===========================================================================

  release:prepare:
    desc: Prepare for release (check status, run tests)
    cmds:
      - echo "Checking git status..."
      - git status --short
      - echo ""
      - go test ./...
      - echo ""
      - echo "Ready to release!"

  release:tag:
    desc: "Create and push a release tag (usage: task ci:release:tag VERSION=v0.1.0)"
    requires:
      vars: [VERSION]
    cmds:
      - echo "Current tags:"
      - git tag -l | tail -5
      - echo ""
      - echo "Tagging {{.VERSION}}..."
      - git tag -a "{{.VERSION}}" -m "Release {{.VERSION}}"
      - git push origin main
      - git push origin "{{.VERSION}}"
      - echo ""
      - echo "Tag {{.VERSION}} pushed! GitHub Actions will build binaries."

  release:full:
    desc: Full release workflow (test, tag, push)
    cmds:
      - task: release:prepare
      - task: release:tag

  # ===========================================================================
  # BOOTSTRAP TESTING
  # ===========================================================================

  bootstrap:test:macos:
    desc: Test macOS bootstrap script (downloads latest release)
    cmds:
      - echo "Testing macOS bootstrap script..."
      - echo "This will install goup-util to /usr/local/bin/goup-util"
      - bash scripts/macos-bootstrap.sh

  bootstrap:test:macos:local:
    desc: Test macOS bootstrap script locally (debug mode)
    cmds:
      - bash -x scripts/macos-bootstrap.sh

  bootstrap:info:
    desc: Show bootstrap script URLs and installation locations
    cmds:
      - |
        echo "Bootstrap Script URLs:"
        echo ""
        echo "macOS:"
        echo "  curl -fsSL https://raw.githubusercontent.com/joeblew999/goup-util/main/scripts/macos-bootstrap.sh | bash"
        echo ""
        echo "Windows:"
        echo "  iwr https://raw.githubusercontent.com/joeblew999/goup-util/main/scripts/windows-bootstrap.ps1 -UseBasicParsing | iex"
        echo ""
        echo "Installation Locations:"
        echo "  macOS - /usr/local/bin/goup-util"
        echo "  Windows - %USERPROFILE%\\goup-util.exe"

  # ===========================================================================
  # SELF BUILD
  # ===========================================================================

  self:build:
    desc: Build goup-util binaries for all platforms
    cmds:
      - "{{.GOUP}} self build"

  self:test:
    desc: Test self build locally
    cmds:
      - "{{.GOUP}} self test"

  # ===========================================================================
  # GENERATE TASKS
  # ===========================================================================

  generate:
    desc: Run all generate tasks (docs, etc.)
    cmds:
      - echo "Running all generate tasks..."
      - task: generate:docs
      - echo "All generate tasks complete!"

  generate:docs:
    desc: Generate CLI documentation
    cmds:
      - echo "Generating CLI documentation..."
      - "{{.GOUP}} docs docs/cli"
      - echo "âœ“ CLI docs generated in docs/cli/"

  generate:all:
    desc: Generate everything (alias for generate)
    cmds:
      - task: generate

  # ===========================================================================
  # PREPARE (BUILD + GENERATE + TEST)
  # ===========================================================================

  prepare:
    desc: Prepare release (build + generate + test) - like xplat pattern
    cmds:
      - echo "=== Prepare Release ==="
      - echo ""
      - echo "1. Running tests..."
      - go test ./...
      - echo ""
      - echo "2. Building examples..."
      - task: build
      - echo ""
      - echo "3. Generating documentation..."
      - task: generate
      - echo ""
      - echo "4. Checking git status..."
      - git status --short
      - echo ""
      - echo "=== Prepare complete! Ready for release ==="

  prepare:full:
    desc: Full prepare with force rebuild
    cmds:
      - echo "=== Full Prepare (Force Rebuild) ==="
      - echo ""
      - echo "1. Running tests..."
      - go test ./...
      - echo ""
      - echo "2. Force rebuilding examples..."
      - task: build:force
      - echo ""
      - echo "3. Generating documentation..."
      - task: generate
      - echo ""
      - echo "4. Checking git status..."
      - git status --short
      - echo ""
      - echo "=== Full prepare complete! ==="
